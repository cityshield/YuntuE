# 下载模块测试面板使用指南

## 概述

本测试面板是为下载模块核心功能设计的可视化自动化测试工具,帮助开发者快速验证下载模块的6大核心特性是否正常工作。

## 功能特性

### 核心测试项

1. **大文件断点续传功能**
   - 测试下载暂停和恢复
   - 验证断点位置正确性
   - 检查数据完整性

2. **多任务并发下载管理**
   - 验证最大并发数限制(3个)
   - 测试队列管理机制
   - 检查任务调度顺序

3. **实时进度监控和速度计算**
   - 监控进度更新频率
   - 验证速度计算准确性
   - 检查剩余时间预估

4. **文件完整性校验 (MD5)**
   - 测试自动MD5校验
   - 验证校验结果准确性
   - 检查校验失败处理

5. **任务状态管理**
   - 测试各种状态转换
   - 验证状态一致性
   - 检查异常状态处理

6. **OSS临时凭证自动刷新机制**
   - 模拟凭证过期场景
   - 验证自动刷新机制
   - 检查下载连续性

## 使用方法

### 方法 1: 键盘快捷键 (推荐)

**仅在开发环境可用**

- **Windows/Linux**: 按 `Ctrl + Shift + T`
- **macOS**: 按 `Cmd + Shift + T`

再次按快捷键可关闭测试面板。

### 方法 2: 控制台命令

在浏览器开发者工具的控制台中,你会看到提示:

```
💡 提示: 按 Ctrl+Shift+T (Mac: Cmd+Shift+T) 打开测试面板
```

## 测试面板界面

```
┌────────────────────────────────────────────────────────┐
│  🧪 下载模块测试面板                                    │
│  ┌────────────────────────────────────────────────┐    │
│  │  [一键运行全部测试] 🚀                          │    │
│  └────────────────────────────────────────────────┘    │
│                                                         │
│  ┌─ 测试 1: 大文件断点续传功能 ───────────────────┐    │
│  │  状态: ✅ 通过                                   │    │
│  │  [运行测试] ▼ (点击展开/收起详情)              │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │ 测试场景: 下载大文件 → 暂停 → 继续 → 验证 │  │    │
│  │  │                                            │  │    │
│  │  │ 测试日志:                                  │  │    │
│  │  │ 15:23:45  📝 开始测试: 大文件断点续传功能  │  │    │
│  │  │ 15:23:45  步骤 1: 创建测试下载任务 (100MB) │  │    │
│  │  │ 15:23:46  ✓ 下载已启动, 状态: downloading   │  │    │
│  │  │ 15:23:46  步骤 2: 模拟下载进行 (进度: 35%) │  │    │
│  │  │ 15:23:47  步骤 3: 暂停下载                 │  │    │
│  │  │ 15:23:47  ✓ 下载已暂停, 进度保持在: 35%    │  │    │
│  │  │ 15:23:48  步骤 4: 继续下载 (断点续传)      │  │    │
│  │  │ 15:23:48  ✓ 断点续传成功, 从 35% 继续下载  │  │    │
│  │  │ 15:23:49  步骤 5: 验证下载数据完整性       │  │    │
│  │  │ 15:23:49  ✓ 数据完整性验证通过             │  │    │
│  │  │ 15:23:49  ✅ 测试通过: 断点续传功能正常    │  │    │
│  │  │ 15:23:49  ⏱️ 测试耗时: 4.23秒             │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────┘    │
│                                                         │
│  [测试 2: 多任务并发下载管理]   ⚪ 未运行   [运行]    │
│  [测试 3: 实时进度监控和速度计算] ⚪ 未运行   [运行]    │
│  [测试 4: 文件完整性校验 (MD5)]  ⚪ 未运行   [运行]    │
│  [测试 5: 任务状态管理]         ⚪ 未运行   [运行]    │
│  [测试 6: OSS临时凭证自动刷新]   ⚪ 未运行   [运行]    │
│                                                         │
│  ┌─ 测试结果汇总 ──────────────────────────────────┐  │
│  │  ✅ 通过: 1   ❌ 失败: 0   ⏸️ 运行中: 0        │  │
│  │  ⚪ 未运行: 5                                   │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────┘
```

## 操作指南

### 运行单个测试

1. 点击任意测试项的**标题区域**可展开/收起详情
2. 点击**"运行测试"**按钮启动该测试
3. 测试执行期间会实时显示日志
4. 测试完成后状态会更新为:
   - ✅ 通过 (绿色)
   - ❌ 失败 (红色)

### 运行全部测试

点击顶部的**"一键运行全部测试"**按钮,将按顺序执行全部6个测试,每个测试之间间隔500ms。

### 查看测试日志

- 每个测试项都可以展开查看详细日志
- 日志使用不同颜色标识:
  - **白色**: 普通信息
  - **绿色**: 成功/通过
  - **红色**: 错误/失败
  - **黄色**: 警告

### 状态指示器

- ⚪ **未运行**: 测试尚未执行
- ⏸️ **运行中**: 测试正在执行
- ✅ **通过**: 测试执行成功
- ❌ **失败**: 测试执行失败

## 测试详情

### 测试 1: 大文件断点续传功能

**测试步骤:**
1. 创建 100MB 测试下载任务
2. 启动下载
3. 模拟下载到 35% 左右
4. 暂停下载
5. 验证暂停状态和进度保持
6. 恢复下载(断点续传)
7. 验证从断点继续下载
8. 检查数据完整性

**预期结果:**
- 下载可以正常暂停
- 暂停后进度不会丢失
- 恢复下载从断点继续
- 数据完整性保持

### 测试 2: 多任务并发下载管理

**测试步骤:**
1. 同时创建 5 个下载任务
2. 检查实际下载中的任务数 (应≤3)
3. 检查等待中的任务数
4. 验证队列管理机制

**预期结果:**
- 最多只有 3 个任务同时下载
- 多余的任务进入等待队列
- 队列按创建时间顺序执行

### 测试 3: 实时进度监控和速度计算

**测试步骤:**
1. 创建 50MB 测试任务
2. 启动下载
3. 采样 5 次进度和速度数据
4. 验证进度递增
5. 验证速度计算
6. 检查剩余时间预估

**预期结果:**
- 进度持续递增,不倒退
- 速度计算准确,数值合理
- 剩余时间预估有效

### 测试 4: 文件完整性校验 (MD5)

**测试步骤:**
1. 创建带 MD5 的测试任务
2. 等待下载完成
3. 检查是否进入校验状态
4. 验证 MD5 校验结果

**预期结果:**
- 下载完成后自动进入校验状态
- MD5 计算正确
- 校验通过后任务标记为成功

### 测试 5: 任务状态管理

**测试步骤:**
1. 创建测试任务
2. 测试 WAITING → DOWNLOADING
3. 测试 DOWNLOADING → PAUSED
4. 测试 PAUSED → DOWNLOADING
5. 测试 DOWNLOADING → CANCELLED

**预期结果:**
- 所有状态转换正常
- 状态转换符合预期
- 不会出现非法状态

### 测试 6: OSS临时凭证自动刷新机制

**测试步骤:**
1. 检查当前 OSS 凭证
2. 创建长时间下载任务 (200MB)
3. 模拟凭证即将过期
4. 验证自动刷新机制触发
5. 检查下载是否继续

**预期结果:**
- 凭证过期前自动刷新
- 刷新后获得新凭证
- 下载不中断,继续进行

## 常见问题

### Q: 为什么按快捷键没有反应?

**A:** 测试面板仅在开发环境 (`npm run electron:dev`) 中可用。生产环境不会加载测试面板。

### Q: 测试失败了怎么办?

**A:**
1. 查看详细日志,找到失败原因
2. 检查 DownloadManager 是否正常初始化
3. 确认网络连接正常
4. 查看控制台是否有错误信息
5. 重新运行测试确认问题

### Q: 可以自定义测试参数吗?

**A:** 当前版本使用预设的测试参数。如需自定义,可以修改 `src/components/DownloadTestPanel.vue` 中的测试函数。

### Q: 测试数据会保留吗?

**A:** 所有测试数据都是临时的,测试完成后会自动清理,不会影响实际下载任务。

### Q: 多个测试可以同时运行吗?

**A:** 不建议。测试面板设计为顺序执行,使用"一键运行全部测试"功能可以自动按顺序执行所有测试。

## 技术实现

### 组件架构

```
src/components/DownloadTestPanel.vue
  ├── 测试状态管理 (reactive)
  ├── 6 个测试函数
  │   ├── test1_ResumableDownload()
  │   ├── test2_ConcurrentDownload()
  │   ├── test3_ProgressCalculation()
  │   ├── test4_MD5Verification()
  │   ├── test5_StatusManagement()
  │   └── test6_OSSCredentialRefresh()
  ├── 日志记录系统
  └── UI 展示层
```

### 集成方式

测试面板通过 `el-dialog` 集成到 [DownloadArea.vue](../src/views/Downloads/DownloadArea.vue) 中:

```vue
<!-- DownloadArea.vue -->
<el-dialog v-model="showTestPanel" ...>
  <DownloadTestPanel />
</el-dialog>
```

键盘快捷键监听:

```typescript
const handleKeyPress = (e: KeyboardEvent) => {
  if (import.meta.env.DEV) {
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
      e.preventDefault()
      showTestPanel.value = !showTestPanel.value
    }
  }
}
```

## 开发环境检测

测试面板只在开发模式下可用,通过 `import.meta.env.DEV` 判断:

```typescript
if (import.meta.env.DEV) {
  // 开发模式: 启用测试面板
  console.log('💡 提示: 按 Ctrl+Shift+T 打开测试面板')
}
```

生产构建时,测试面板代码会被 tree-shaking 优化掉,不会增加生产包体积。

## 性能影响

- **开发环境**: 测试面板仅在需要时加载,不影响正常开发
- **生产环境**: 完全不加载,零性能影响
- **测试执行**: 所有测试使用 mock 数据,不产生实际网络请求

## 后续优化计划

1. 支持自定义测试参数
2. 添加测试报告导出功能
3. 支持批量压力测试
4. 添加性能基准测试
5. 集成到 CI/CD 流程

## 相关文档

- [下载模块技术设计](./download-module-technical-design.md)
- [下载模块测试计划](./download-module-test-plan.md)
- [DownloadManager API 文档](../src/utils/download/DownloadManager.ts)
- [下载类型定义](../src/types/download.ts)

## 反馈与贡献

如有问题或建议,请联系开发团队或提交 Issue。
