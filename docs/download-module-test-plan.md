# 下载模块核心特性测试方案

## 测试概述

本测试方案旨在验证"我的下载"模块的6项核心特性的可靠性和稳定性。

---

## 测试 1: 大文件断点续传功能

### 测试目标
验证下载过程中断后能够从断点处继续下载，而不是从头开始

### 前置条件
- 准备一个大于 500MB 的测试文件上传到 OSS
- 获取文件的 OSS URL 和临时凭证
- 确保本地有足够的磁盘空间

### 测试步骤

#### 1.1 正常下载中断测试
1. 启动一个大文件下载任务（建议 1GB+）
2. 等待下载进度达到 30%-50%
3. 点击"暂停"按钮
4. **验证点**: 检查以下内容
   - 任务状态变为 "PAUSED"
   - 已下载的字节数被记录
   - 本地临时文件存在且大小正确
   - localStorage 中保存了断点信息
5. 点击"继续"按钮
6. **验证点**:
   - 任务状态变为 "DOWNLOADING"
   - 从上次中断的位置继续下载（通过速度和剩余时间判断）
   - 不重新下载已完成的部分
7. 等待下载完成
8. **验证点**:
   - 文件完整性校验通过
   - 文件大小正确

#### 1.2 网络中断自动恢复测试
1. 启动一个大文件下载任务
2. 等待下载进度达到 20%-30%
3. **模拟网络中断**: 断开网络连接（关闭 WiFi 或拔网线）
4. **验证点**:
   - 任务状态变为 "FAILED"
   - 错误信息显示网络相关错误
5. 恢复网络连接
6. 点击"重试"按钮
7. **验证点**:
   - 从断点处继续下载
   - 下载成功完成

#### 1.3 应用重启后恢复测试
1. 启动一个大文件下载任务
2. 等待下载进度达到 40%-60%
3. 点击"暂停"
4. **关闭应用**
5. 重新启动应用
6. 进入"我的下载"页面
7. **验证点**:
   - 之前的下载任务仍然存在
   - 任务状态为 "PAUSED"
   - 已下载进度正确显示
8. 点击"继续"
9. **验证点**:
   - 从断点处继续下载
   - 下载成功完成

### 预期结果
- 所有暂停/继续操作都能从正确的断点恢复
- 不会重复下载已完成的部分
- 应用重启后能恢复下载状态
- 最终文件完整且可用

### 实现检查清单
- [ ] `OSSDownloader.ts` 中的 `resumeDownload()` 方法正确计算起始位置
- [ ] `Range` 请求头设置正确: `bytes=${downloadedSize}-${fileSize - 1}`
- [ ] localStorage 正确保存和恢复下载进度
- [ ] 临时文件的 append 操作正确

---

## 测试 2: 多任务并发下载管理

### 测试目标
验证系统能够正确管理多个并发下载任务，遵守并发限制

### 前置条件
- 准备至少 10 个不同大小的测试文件（100MB - 2GB）
- 确认 `maxConcurrent` 配置为 3（默认值）

### 测试步骤

#### 2.1 并发限制测试
1. 同时添加 10 个下载任务
2. **验证点**:
   - 只有 3 个任务处于 "DOWNLOADING" 状态
   - 其余 7 个任务处于 "WAITING" 状态
3. 观察任务队列变化
4. **验证点**:
   - 当一个任务完成时，等待队列中的下一个任务自动开始
   - 始终保持最多 3 个任务同时下载

#### 2.2 优先级队列测试
1. 添加 5 个下载任务（都处于等待状态）
2. 暂停一个正在下载的任务
3. **验证点**:
   - 等待队列中的第一个任务立即开始下载
4. 继续之前暂停的任务
5. **验证点**:
   - 暂停的任务进入等待队列尾部（或立即开始，取决于当前并发数）

#### 2.3 取消任务测试
1. 启动 5 个下载任务
2. 取消一个正在下载的任务
3. **验证点**:
   - 任务从列表中移除
   - 临时文件被删除
   - 等待队列中的任务自动补充进来
   - 并发数保持不变

#### 2.4 全部暂停/全部继续测试
1. 启动 10 个下载任务
2. 点击"全部暂停"按钮（如果有）
3. **验证点**:
   - 所有 DOWNLOADING 状态的任务变为 PAUSED
   - 所有 WAITING 状态的任务保持 WAITING
4. 点击"全部继续"按钮
5. **验证点**:
   - 遵守并发限制（最多 3 个同时下载）
   - 其余任务进入等待队列

### 预期结果
- 并发数量始终不超过配置的 `maxConcurrent`
- 任务队列管理正确，FIFO 原则
- 任务状态转换流畅无误
- 资源释放及时（取消任务后）

### 实现检查清单
- [ ] `DownloadManager.ts` 中的 `processQueue()` 方法正确限制并发数
- [ ] 任务完成/失败/取消后正确触发 `processQueue()`
- [ ] `getDownloadingCount()` 准确计算当前下载中的任务数
- [ ] 任务优先级和队列顺序正确

---

## 测试 3: 实时进度监控和速度计算

### 测试目标
验证下载进度、速度和剩余时间的计算准确性

### 前置条件
- 准备不同大小的测试文件（500MB, 1GB, 2GB）
- 确保网络环境稳定

### 测试步骤

#### 3.1 进度百分比准确性测试
1. 启动一个 1GB 文件的下载
2. 每隔 10 秒记录一次进度百分比
3. **验证点**:
   - 进度百分比单调递增（不会倒退）
   - 进度计算公式正确: `progress = (downloadedSize / totalSize) * 100`
   - 进度显示精确到小数点后1位
4. 暂停后继续下载
5. **验证点**:
   - 进度从正确的位置继续累加
   - 不会跳跃或归零

#### 3.2 下载速度计算测试
1. 启动下载任务
2. 观察下载速度的变化
3. **验证点**:
   - 速度单位正确（B/s, KB/s, MB/s）
   - 速度数值合理（符合当前网络带宽）
   - 速度更新频率合适（建议 1 秒更新一次）
4. 使用网络监控工具对比
5. **验证点**:
   - 客户端显示的速度与实际网络流量基本一致（误差 <10%）

#### 3.3 剩余时间估算测试
1. 启动一个大文件下载
2. 等待速度稳定（约 30 秒）
3. 记录剩余时间估算值
4. **验证点**:
   - 剩余时间计算公式: `remainingTime = (totalSize - downloadedSize) / speed`
   - 时间格式正确（HH:MM:SS 或 MM:SS）
   - 时间估算相对准确（误差 <20%）
5. 观察网络波动时的表现
6. **验证点**:
   - 使用移动平均速度计算，避免剩余时间剧烈波动

#### 3.4 UI 更新性能测试
1. 同时下载 5 个文件
2. 观察界面更新流畅度
3. **验证点**:
   - 进度条更新流畅，无卡顿
   - 速度和剩余时间更新及时
   - CPU 占用合理（<5%）
4. 使用浏览器开发者工具检查
5. **验证点**:
   - 没有频繁的重渲染（使用 React DevTools Profiler）
   - 状态更新使用防抖/节流机制

### 预期结果
- 进度百分比准确无误
- 下载速度实时且准确
- 剩余时间估算合理
- UI 更新流畅不卡顿

### 实现检查清单
- [ ] `OSSDownloader.ts` 中的速度计算使用滑动窗口平均
- [ ] 进度更新频率控制在 500ms-1s
- [ ] 使用 `computed` 或 `useMemo` 优化计算
- [ ] 格式化函数（formatSize, formatTime）正确实现

---

## 测试 4: 文件完整性校验 (MD5)

### 测试目标
验证下载完成后的 MD5 校验机制

### 前置条件
- 准备测试文件并预先计算 MD5 值
- 确保服务端返回正确的 MD5 值

### 测试步骤

#### 4.1 正常校验测试
1. 下载一个文件（服务端提供正确的 MD5）
2. 等待下载完成
3. **验证点**:
   - 任务状态变为 "VERIFYING"（校验中）
   - 显示"正在校验文件完整性..."
4. 校验完成
5. **验证点**:
   - 任务状态变为 "SUCCESS"
   - 显示"校验通过"或类似提示
   - 本地文件的 MD5 与服务端匹配

#### 4.2 校验失败测试
1. 手动修改下载配置，模拟 MD5 不匹配
   - 方法1: 修改本地文件内容
   - 方法2: 修改代码中的预期 MD5 值
2. 触发校验
3. **验证点**:
   - 任务状态变为 "FAILED"
   - 错误信息: "文件校验失败，MD5 不匹配"
   - 提供"重新下载"选项

#### 4.3 无 MD5 值处理测试
1. 下载一个服务端未提供 MD5 的文件
2. 等待下载完成
3. **验证点**:
   - 跳过 MD5 校验
   - 直接标记为 "SUCCESS"
   - 显示警告: "服务端未提供 MD5，无法校验"

#### 4.4 大文件校验性能测试
1. 下载一个 5GB+ 的大文件
2. 等待下载完成，观察校验过程
3. **验证点**:
   - 校验过程显示进度（如果可能）
   - 校验时间合理（不超过文件大小/100MB * 1秒）
   - 校验期间 UI 不卡顿
   - 使用 Worker 线程计算 MD5（如果实现）

### 预期结果
- 正常情况下校验成功
- 文件损坏时能检测出来
- 无 MD5 时有合理降级处理
- 大文件校验不阻塞 UI

### 实现检查清单
- [ ] 使用 Electron 的 `crypto` 模块计算 MD5
- [ ] 校验失败后提供重试机制
- [ ] 校验状态正确反映在 UI 上
- [ ] 考虑使用 Web Worker 或 Node Worker 线程

---

## 测试 5: 任务状态管理

### 测试目标
验证下载任务在各个状态之间的转换是否正确

### 测试步骤

#### 5.1 状态转换路径测试

测试所有合法的状态转换:

```
WAITING → DOWNLOADING → SUCCESS
WAITING → DOWNLOADING → PAUSED → DOWNLOADING → SUCCESS
WAITING → DOWNLOADING → FAILED → DOWNLOADING (重试)
DOWNLOADING → FAILED → DOWNLOADING → SUCCESS
DOWNLOADING → VERIFYING → SUCCESS
DOWNLOADING → VERIFYING → FAILED
```

#### 5.2 详细测试步骤

1. **WAITING → DOWNLOADING**
   - 添加任务时状态为 WAITING
   - 轮到执行时自动变为 DOWNLOADING
   - **验证**: 状态更新、UI 变化、队列调整

2. **DOWNLOADING → PAUSED**
   - 点击暂停按钮
   - **验证**:
     - 状态变为 PAUSED
     - 下载停止
     - 进度保存
     - 显示"继续"按钮

3. **PAUSED → DOWNLOADING**
   - 点击继续按钮
   - **验证**:
     - 状态恢复为 DOWNLOADING
     - 从断点继续
     - 显示"暂停"按钮

4. **DOWNLOADING → FAILED**
   - 模拟网络错误或文件不存在
   - **验证**:
     - 状态变为 FAILED
     - 显示错误信息
     - 显示"重试"按钮
     - 错误计数增加

5. **FAILED → DOWNLOADING**
   - 点击重试按钮
   - **验证**:
     - 状态恢复为 DOWNLOADING
     - 从断点或从头开始（取决于错误类型）

6. **DOWNLOADING → VERIFYING**
   - 下载完成后自动进入校验
   - **验证**:
     - 状态变为 VERIFYING
     - 显示校验提示
     - 进度条显示 100%

7. **VERIFYING → SUCCESS**
   - MD5 校验通过
   - **验证**:
     - 状态变为 SUCCESS
     - 显示完成时间
     - 提供"打开文件"和"打开文件夹"选项

8. **VERIFYING → FAILED**
   - MD5 校验失败
   - **验证**:
     - 状态变为 FAILED
     - 错误信息: "MD5 校验失败"
     - 提供重新下载选项

#### 5.3 非法状态转换测试

验证系统拒绝非法的状态转换:

1. SUCCESS → DOWNLOADING (不允许，已完成的任务不能继续)
2. SUCCESS → PAUSED (不允许)
3. WAITING → PAUSED (不允许，还没开始就不能暂停)
4. VERIFYING → PAUSED (不允许，校验中不能暂停)

**验证点**:
- 这些操作被忽略或显示错误提示
- 任务状态不变

#### 5.4 并发状态管理测试

1. 同时操作多个任务（暂停、继续、取消）
2. **验证点**:
   - 每个任务的状态独立管理
   - 不会互相干扰
   - 状态更新正确反映到 UI

### 预期结果
- 所有状态转换符合预期
- 非法转换被正确阻止
- 状态持久化和恢复正常
- 并发状态管理无冲突

### 实现检查清单
- [ ] `DownloadStatus` 枚举定义完整
- [ ] 状态转换逻辑在 `DownloadManager` 中集中管理
- [ ] 状态变更触发 UI 更新（reactive）
- [ ] localStorage 正确保存状态

---

## 测试 6: OSS 临时凭证自动刷新机制

### 测试目标
验证当 OSS 临时凭证即将过期时，系统能自动刷新凭证并继续下载

### 前置条件
- 配置短期 OSS 临时凭证（建议 5-10 分钟过期，方便测试）
- 准备大文件（下载时间需要超过凭证有效期）

### 测试步骤

#### 6.1 自动刷新测试
1. 启动一个大文件下载（预计下载时间 > 凭证有效期）
2. 观察日志输出
3. **验证点**:
   - 在凭证过期前（建议提前 2-5 分钟），系统自动发起刷新请求
   - 日志显示: "OSS 凭证即将过期，开始刷新..."
4. 凭证刷新成功
5. **验证点**:
   - 下载继续进行，无中断
   - 新凭证应用到后续的请求中
   - 日志显示: "OSS 凭证刷新成功"

#### 6.2 刷新失败重试测试
1. 启动下载任务
2. 模拟凭证刷新 API 失败（可通过修改代码或断网模拟）
3. **验证点**:
   - 系统进行重试（建议 3 次）
   - 每次重试间隔递增（如 1s, 2s, 4s）
   - 日志显示重试信息
4. 如果重试全部失败
5. **验证点**:
   - 下载任务标记为 FAILED
   - 错误信息: "OSS 凭证刷新失败"
   - 用户可以手动重试

#### 6.3 多任务凭证共享测试
1. 同时启动 5 个下载任务
2. 等待凭证即将过期
3. **验证点**:
   - 只发起一次凭证刷新请求（不是每个任务各自刷新）
   - 所有任务共享新的凭证
   - 刷新过程中，所有任务正常下载

#### 6.4 凭证过期时间检测测试
1. 检查代码中的过期时间检测逻辑
2. **验证点**:
   - 从服务端获取的 `expiration` 字段正确解析
   - 计算剩余时间准确: `remainingTime = expiration - Date.now()`
   - 刷新阈值合理（建议在过期前 5 分钟或剩余时间的 20%）

#### 6.5 边界条件测试
1. 凭证已经过期（启动下载时就过期）
   - **验证**: 立即刷新凭证
2. 凭证有效期很短（<1分钟）
   - **验证**: 下载前先刷新
3. 刷新返回的新凭证也即将过期
   - **验证**: 继续监控并再次刷新

### 预期结果
- 凭证自动刷新，下载不中断
- 刷新失败有合理的重试和降级策略
- 多任务共享凭证，避免重复刷新
- 边界情况处理正确

### 实现检查清单
- [ ] `OSSCredentials` 接口包含 `expiration` 字段
- [ ] `DownloadManager` 或 `OSSDownloader` 实现凭证刷新逻辑
- [ ] 定时检查凭证有效期（setInterval）
- [ ] 刷新 API 调用正确（调用服务端接口）
- [ ] 刷新后更新所有正在进行的下载任务

---

## 测试工具和辅助脚本

### Mock 数据生成器

在 `DownloadArea.vue` 中已经有 `generateMockData()` 函数，可以用于测试。

### 网络条件模拟

**Chrome DevTools 方法**:
1. 打开 DevTools (F12)
2. Network → Throttling → Add custom profile
3. 设置不同的网络速度（Fast 3G, Slow 3G, Offline）

**Charles/Fiddler 方法**:
使用代理工具模拟:
- 网络延迟
- 丢包
- 限速
- 断网

### 日志监控

在测试过程中，监控以下日志:

```bash
# 查看实时日志
tail -f ~/Library/Application\ Support/YuntuE/logs/main-*.log
```

关键日志关键词:
- `[Download]` - 下载相关
- `[OSS]` - OSS 操作
- `[MD5]` - 文件校验
- `[DownloadManager]` - 任务管理

---

## 测试报告模板

### 测试结果记录表

| 测试项 | 测试用例 | 状态 | 问题描述 | 严重程度 | 截图 |
|-------|---------|------|---------|---------|------|
| 断点续传 | 1.1 正常下载中断 | ✅ / ❌ |  |  |  |
| 断点续传 | 1.2 网络中断恢复 | ✅ / ❌ |  |  |  |
| 断点续传 | 1.3 应用重启恢复 | ✅ / ❌ |  |  |  |
| 并发管理 | 2.1 并发限制 | ✅ / ❌ |  |  |  |
| ... | ... | ... | ... | ... | ... |

### 问题严重程度定义

- **P0 致命**: 功能完全不可用，阻塞测试
- **P1 严重**: 核心功能异常，但有绕过方案
- **P2 一般**: 非核心功能问题，用户体验受影响
- **P3 轻微**: UI/文案问题，不影响功能

---

## 性能基准

### 下载性能指标

| 指标 | 目标值 | 测试环境 |
|-----|-------|---------|
| 单任务最大速度 | > 50 MB/s | 千兆网络 |
| 3 个并发任务总速度 | > 100 MB/s | 千兆网络 |
| 暂停响应时间 | < 500ms |  |
| 继续下载响应时间 | < 1s |  |
| MD5 校验速度 | > 100 MB/s | 1GB 文件 |
| UI 刷新频率 | 1-2 次/秒 |  |
| 内存占用增长 | < 100MB | 下载 10GB 文件 |

---

## 测试环境配置

### 推荐测试环境

**环境 1: 正常网络**
- 网络: 千兆有线/5G WiFi
- 用途: 功能正确性测试

**环境 2: 受限网络**
- 网络: 限速到 10 Mbps
- 用途: 低速网络下的稳定性测试

**环境 3: 不稳定网络**
- 网络: 模拟丢包 5-10%
- 用途: 容错性和重试机制测试

### OSS 配置

```typescript
// 测试用 OSS 配置
const testOSSConfig = {
  region: 'oss-cn-beijing',
  bucket: 'yuntu-test',
  // 使用短期凭证方便测试刷新机制
  stsTokenExpiration: 10 * 60 * 1000, // 10 分钟
}
```

---

## 自动化测试建议

虽然本测试计划主要针对手动测试，但以下场景建议实现自动化:

### 单元测试

```typescript
// DownloadManager.test.ts
describe('DownloadManager', () => {
  test('并发限制: 最多 3 个任务同时下载', () => {
    // ...
  })

  test('断点续传: 从正确位置继续', () => {
    // ...
  })

  test('MD5 校验: 正确计算文件哈希', () => {
    // ...
  })
})
```

### 集成测试

使用 Playwright 或 Spectron 测试完整流程:

```typescript
test('完整下载流程', async ({ page }) => {
  await page.click('[data-test="add-download"]')
  await page.waitForSelector('[data-test="download-progress"]')
  await page.click('[data-test="pause-download"]')
  // ...
})
```

---

## 测试检查清单

在开始测试前，确认以下准备工作:

- [ ] 测试环境搭建完成（开发环境/打包后环境）
- [ ] OSS 测试账号和凭证准备就绪
- [ ] 测试文件上传到 OSS（不同大小: 100MB, 500MB, 1GB, 5GB）
- [ ] 网络模拟工具安装（Charles/Chrome DevTools）
- [ ] 日志查看工具准备（终端/日志查看器）
- [ ] 测试报告模板准备
- [ ] 预留充足的测试时间（建议 4-6 小时）
- [ ] 备份重要数据（测试可能产生大量临时文件）

---

## 常见问题和调试建议

### 问题 1: 下载速度异常慢
**可能原因**:
- OSS 区域选择不当（跨区域）
- 本地网络限制
- 并发数设置过高导致抢占

**调试方法**:
- 使用 OSS 官方工具测试下载速度
- 检查网络带宽
- 调整 `maxConcurrent` 参数

### 问题 2: 断点续传失败
**可能原因**:
- Range 请求头设置错误
- 服务端不支持 Range 请求
- 临时文件被意外删除

**调试方法**:
- 查看网络请求的 Range 头
- 检查服务端响应的 Content-Range
- 检查临时文件是否存在

### 问题 3: MD5 校验总是失败
**可能原因**:
- 下载过程中文件损坏
- MD5 计算方法不一致
- 服务端返回的 MD5 值错误

**调试方法**:
- 手动计算本地文件 MD5: `md5 /path/to/file`
- 对比服务端提供的 MD5
- 检查是否有额外的字符（如换行符）

---

## 测试时间安排建议

| 测试阶段 | 预计时间 | 备注 |
|---------|---------|------|
| 测试 1: 断点续传 | 1.5 小时 | 包含大文件下载等待时间 |
| 测试 2: 并发管理 | 1 小时 |  |
| 测试 3: 进度监控 | 1 小时 |  |
| 测试 4: MD5 校验 | 1 小时 |  |
| 测试 5: 状态管理 | 1 小时 |  |
| 测试 6: 凭证刷新 | 1.5 小时 | 需要等待凭证过期 |
| **总计** | **7 小时** |  |

建议分多天进行，每天测试 2-3 个特性，保持专注度。

---

## 下一步行动

1. 阅读并理解本测试方案
2. 搭建测试环境（上传测试文件到 OSS）
3. 按照顺序执行测试 1-6
4. 记录测试结果和发现的问题
5. 提交 Bug 报告或优化建议
6. 修复问题后进行回归测试

**祝测试顺利！** 🚀
